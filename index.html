<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A4轉A6小冊子拼版工具 (影像重製版)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF-Lib for creating the booklet -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- PDF.js for robust reading/rendering of source files -->
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;
        const { PDFDocument, rgb, degrees, PageSizes, LineCapStyle } = PDFLib;

        // Set worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';

        // --- Icons ---
        const IconUpload = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" />
            </svg>
        );
        const IconFileText = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" />
            </svg>
        );
        const IconScissors = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="6" cy="6" r="3" /><circle cx="6" cy="18" r="3" /><line x1="20" y1="4" x2="8.12" y2="15.88" /><line x1="14.47" y1="14.48" x2="20" y2="20" /><line x1="8.12" y1="8.12" x2="12" y2="12" />
            </svg>
        );
        const IconLayers = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" />
            </svg>
        );
        const IconArrowDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="5" x2="12" y2="19" /><polyline points="19 12 12 19 5 12" />
            </svg>
        );
        const IconDownload = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" />
            </svg>
        );
        const IconAlertCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
        );
        const IconCheckCircle2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" /><path d="m9 12 2 2 4-4" />
            </svg>
        );
        const IconFoldAction = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="4" y="4" width="16" height="16" rx="1" />
                <line x1="12" y1="4" x2="12" y2="20" strokeDasharray="2 2" />
                <path d="M18 12c0-4-2.5-6-6-6" />
                <path d="M12 6l2 2" />
                <path d="M12 6l2-2" />
            </svg>
        );
        const IconStaple = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                <line x1="8" y1="9" x2="8" y2="11" strokeWidth="2.5" />
                <line x1="8" y1="15" x2="8" y2="17" strokeWidth="2.5" />
            </svg>
        );
        const IconEye = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                <circle cx="12" cy="12" r="3" />
            </svg>
        );
        const IconBookOpen = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
            </svg>
        );
        const IconChevronDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m6 9 6 6 6-6" />
            </svg>
        );
        const IconChevronUp = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m18 15-6-6-6 6" />
            </svg>
        );
        const IconImage = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                <circle cx="9" cy="9" r="2" />
                <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
            </svg>
        );
        const IconGrid = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect width="18" height="18" x="3" y="3" rx="2" />
                <path d="M3 12h18" />
                <path d="M12 3v18" />
            </svg>
        );

        // A4 Dimensions
        const A4_WIDTH = 595.28;
        const A4_HEIGHT = 841.89;

        function App() {
            const [file, setFile] = useState(null);
            const [cachedSrcPages, setCachedSrcPages] = useState(null);
            const [previewInfo, setPreviewInfo] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState("");
            const [downloadUrl, setDownloadUrl] = useState(null);
            const [error, setError] = useState(null);
            const [stats, setStats] = useState(null);
            const [binding, setBinding] = useState('left');
            const [quality, setQuality] = useState(2.5); // Default to Standard (approx 180 DPI)
            const [drawGuides, setDrawGuides] = useState(true); // New state for guide lines
            const [showPreview, setShowPreview] = useState(true);
            const fileInputRef = useRef(null);

            const handleFileChange = async (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile && selectedFile.type === 'application/pdf') {
                    setFile(selectedFile);
                    setDownloadUrl(null);
                    setError(null);
                    setStats(null);
                    setPreviewInfo(null);
                    setCachedSrcPages(null);
                    setShowPreview(true);
                    await analyzeFile(selectedFile);
                } else {
                    setError("請上傳有效的 PDF 檔案");
                }
            };

            const resetResult = () => {
                if (downloadUrl) {
                    setDownloadUrl(null);
                    setStats(null);
                    setShowPreview(false);
                }
            };

            const handleBindingChange = (newBinding) => {
                if (binding === newBinding) return;
                setBinding(newBinding);
                resetResult();
            };

            const handleQualityChange = (newQuality) => {
                if (quality === newQuality) return;
                setQuality(newQuality);
                resetResult();
            };

            const handleGuidesChange = () => {
                setDrawGuides(!drawGuides);
                resetResult();
            };

            // 1. Initial Analysis
            const analyzeFile = async (pdfFile) => {
                try {
                    const arrayBuffer = await pdfFile.arrayBuffer();
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                    const pdfDoc = await loadingTask.promise;
                    const totalSrcPages = pdfDoc.numPages;
                    setCachedSrcPages(totalSrcPages);
                } catch (err) {
                    console.error("Preview analysis failed", err);
                }
            };

            // 2. Generate Preview Data (Reactive)
            useEffect(() => {
                if (!cachedSrcPages) return;

                const totalSrcPages = cachedSrcPages;
                let pagesNeeded = totalSrcPages;
                while (pagesNeeded % 4 !== 0) { pagesNeeded++; }

                const totalStrips = pagesNeeded / 4;
                const sheetsCount = Math.ceil(totalStrips / 2);

                const strips = [];
                for (let i = 0; i < totalStrips; i++) {
                    const p_last = pagesNeeded - (i * 2);
                    const p_first = 1 + (i * 2);
                    const p_second = 2 + (i * 2);
                    const p_last_minus_1 = pagesNeeded - (i * 2) - 1;

                    if (binding === 'left') {
                        strips.push({
                            frontLeft: p_last, frontRight: p_first,
                            backLeft: p_second, backRight: p_last_minus_1
                        });
                    } else {
                        strips.push({
                            frontLeft: p_first, frontRight: p_last,
                            backLeft: p_last_minus_1, backRight: p_second
                        });
                    }
                }

                const tableRows = [];
                for (let s = 0; s < sheetsCount; s++) {
                    const topIdx = s;
                    const btmIdx = s + sheetsCount;

                    const topStrip = strips[topIdx];
                    const btmStrip = strips[btmIdx];

                    tableRows.push({
                        sheet: s + 1,
                        side: 'FRONT',
                        left: { top: topStrip?.frontLeft, bottom: btmStrip?.frontLeft },
                        right: { top: topStrip?.frontRight, bottom: btmStrip?.frontRight }
                    });

                    tableRows.push({
                        sheet: s + 1,
                        side: 'BACK',
                        left: { top: topStrip?.backLeft, bottom: btmStrip?.backLeft },
                        right: { top: topStrip?.backRight, bottom: btmStrip?.backRight }
                    });
                }

                setPreviewInfo({
                    originalPages: totalSrcPages,
                    finalPages: pagesNeeded,
                    sheets: sheetsCount,
                    rows: tableRows
                });

            }, [cachedSrcPages, binding]);


            const processPDF = async () => {
                if (!file) return;

                setDownloadUrl(null);
                setStats(null);
                setShowPreview(false);

                setIsProcessing(true);
                setError(null);
                setProgress("讀取檔案中...");

                try {
                    const fileArrayBuffer = await file.arrayBuffer();

                    setProgress("正在分析檔案 (PDF.js)...");
                    const loadingTask = pdfjsLib.getDocument({ data: fileArrayBuffer });
                    const pdfDoc = await loadingTask.promise;
                    const totalSrcPages = pdfDoc.numPages;

                    let pagesNeeded = totalSrcPages;
                    while (pagesNeeded % 4 !== 0) { pagesNeeded++; }

                    let totalStrips = pagesNeeded / 4;
                    const sheetsCount = Math.ceil(totalStrips / 2);
                    const blankPagesCount = pagesNeeded - totalSrcPages;

                    const destPdf = await PDFDocument.create();

                    const embeddedImages = [];
                    // Use selected quality scale
                    const RENDER_SCALE = quality;

                    for (let i = 1; i <= totalSrcPages; i++) {
                        setProgress(`正在處理第 ${i} / ${totalSrcPages} 頁 (轉檔中)...`);
                        const page = await pdfDoc.getPage(i);
                        const viewport = page.getViewport({ scale: RENDER_SCALE });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        const imgDataUrl = canvas.toDataURL('image/jpeg', 0.8); // JPEG quality 0.8
                        const embeddedImage = await destPdf.embedJpg(imgDataUrl);
                        embeddedImages.push(embeddedImage);
                    }

                    const getImage = (pageOneBasedIndex) => {
                        if (pageOneBasedIndex > totalSrcPages) return null;
                        return embeddedImages[pageOneBasedIndex - 1];
                    };

                    const strips = [];
                    for (let i = 0; i < totalStrips; i++) {
                        const p_last = pagesNeeded - (i * 2);
                        const p_first = 1 + (i * 2);
                        const p_second = 2 + (i * 2);
                        const p_last_minus_1 = pagesNeeded - (i * 2) - 1;

                        if (binding === 'left') {
                            strips.push({
                                frontLeft: p_last, frontRight: p_first,
                                backLeft: p_second, backRight: p_last_minus_1
                            });
                        } else {
                            strips.push({
                                frontLeft: p_first, frontRight: p_last,
                                backLeft: p_last_minus_1, backRight: p_second
                            });
                        }
                    }

                    setProgress("正在拼版...");
                    for (let s = 0; s < sheetsCount; s++) {
                        const topStrip = strips[s];
                        const bottomStrip = strips[s + sheetsCount];

                        // Front
                        const pageFront = destPdf.addPage([A4_WIDTH, A4_HEIGHT]);
                        if (topStrip) {
                            await drawImageOnA4(pageFront, getImage(topStrip.frontLeft), 'top-left');
                            await drawImageOnA4(pageFront, getImage(topStrip.frontRight), 'top-right');
                        }
                        if (bottomStrip) {
                            await drawImageOnA4(pageFront, getImage(bottomStrip.frontLeft), 'bottom-left');
                            await drawImageOnA4(pageFront, getImage(bottomStrip.frontRight), 'bottom-right');
                        }
                        if (drawGuides) drawCenterGuides(pageFront);

                        // Back
                        const pageBack = destPdf.addPage([A4_WIDTH, A4_HEIGHT]);
                        if (topStrip) {
                            await drawImageOnA4(pageBack, getImage(topStrip.backLeft), 'top-left');
                            await drawImageOnA4(pageBack, getImage(topStrip.backRight), 'top-right');
                        }
                        if (bottomStrip) {
                            await drawImageOnA4(pageBack, getImage(bottomStrip.backLeft), 'bottom-left');
                            await drawImageOnA4(pageBack, getImage(bottomStrip.backRight), 'bottom-right');
                        }
                        if (drawGuides) drawCenterGuides(pageBack);

                        setProgress(`正在生成第 ${s + 1} / ${sheetsCount} 張 A4...`);
                    }

                    const pdfBytes = await destPdf.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);

                    setDownloadUrl(url);
                    setStats({
                        originalPages: totalSrcPages,
                        finalPages: pagesNeeded,
                        sheets: sheetsCount,
                        blanks: blankPagesCount
                    });

                } catch (err) {
                    console.error(err);
                    setError("轉換失敗：" + err.message);
                } finally {
                    setIsProcessing(false);
                    setProgress("");
                }
            };

            const drawImageOnA4 = async (destPage, srcImage, position) => {
                if (!srcImage) return;
                const { width: srcW, height: srcH } = srcImage;
                const targetW = A4_WIDTH / 2;
                const targetH = A4_HEIGHT / 2;
                const scale = Math.min(targetW / srcW, targetH / srcH);
                const drawW = srcW * scale;
                const drawH = srcH * scale;
                let x = 0, y = 0;
                const xOffset = (targetW - drawW) / 2;
                const yOffset = (targetH - drawH) / 2;

                switch (position) {
                    case 'top-left': x = xOffset; y = (A4_HEIGHT / 2) + yOffset; break;
                    case 'top-right': x = (A4_WIDTH / 2) + xOffset; y = (A4_HEIGHT / 2) + yOffset; break;
                    case 'bottom-left': x = xOffset; y = yOffset; break;
                    case 'bottom-right': x = (A4_WIDTH / 2) + xOffset; y = yOffset; break;
                }
                destPage.drawImage(srcImage, { x, y, width: drawW, height: drawH });
            };

            const drawCenterGuides = (page) => {
                const centerX = A4_WIDTH / 2;
                const centerY = A4_HEIGHT / 2;

                // Horizontal Cut Line (Dashed)
                page.drawLine({
                    start: { x: 0, y: centerY },
                    end: { x: A4_WIDTH, y: centerY },
                    thickness: 0.2,
                    color: rgb(0.5, 0.5, 0.5),
                    dashArray: [5, 5],
                });

                // Vertical Fold Line (Dashed)
                page.drawLine({
                    start: { x: centerX, y: 0 },
                    end: { x: centerX, y: A4_HEIGHT },
                    thickness: 0.2,
                    color: rgb(0.5, 0.5, 0.5),
                    dashArray: [5, 5],
                });
            };

            const getPageLabel = (pageNum) => {
                if (!pageNum) return '-';
                if (cachedSrcPages && pageNum > cachedSrcPages) return '-';
                return pageNum;
            };

            return (
                <div className="min-h-screen flex flex-col items-center py-10 px-4">
                    <div className="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8">
                        <header className="mb-8 text-center">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">A4 轉 A6 小冊子拼版工具</h1>
                            <p className="text-gray-500">視覺化重製模式・100% 容錯・切分堆疊法</p>
                        </header>

                        {/* Upload Section */}
                        <div className="mb-6">
                            <div
                                className={`border-2 border-dashed rounded-xl p-10 text-center cursor-pointer transition-colors ${file ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-400'}`}
                                onClick={() => fileInputRef.current.click()}
                            >
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileChange}
                                    accept="application/pdf"
                                    className="hidden"
                                />
                                {file ? (
                                    <div className="flex flex-col items-center">
                                        <IconFileText className="w-12 h-12 text-blue-600 mb-2" />
                                        <p className="font-medium text-gray-700">{file.name}</p>
                                        <p className="text-sm text-gray-500 mt-1">點擊更換檔案</p>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center">
                                        <IconUpload className="w-12 h-12 text-gray-400 mb-2" />
                                        <p className="font-medium text-gray-600">點擊或拖拉 PDF 檔案至此</p>
                                        <p className="text-xs text-gray-400 mt-1">支援 A4 / A5 直式檔案</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Settings Section */}
                        {file && (
                            <div className="mb-8 space-y-4">
                                {/* Binding */}
                                <div className="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                                    <div className="flex items-center gap-2 mb-3">
                                        <IconBookOpen className="w-5 h-5 text-slate-600" />
                                        <h3 className="font-bold text-slate-700">拼版裝訂方向 (Binding)</h3>
                                    </div>
                                    <p className="text-sm text-slate-500 mb-4 ml-7">決定拼版時頁面的落版順序 (請看預覽)。</p>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 ml-7">
                                        <label className={`relative flex items-start p-4 border rounded-lg cursor-pointer transition-all ${binding === 'left' ? 'border-blue-500 bg-blue-50/50 ring-1 ring-blue-500' : 'border-slate-200 hover:border-slate-300'}`}>
                                            <input
                                                type="radio"
                                                name="binding"
                                                value="left"
                                                checked={binding === 'left'}
                                                onChange={() => handleBindingChange('left')}
                                                className="mt-1 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                                            />
                                            <div className="ml-3">
                                                <span className="block text-sm font-bold text-slate-800">左翻書 (Left Binding)</span>
                                                <span className="block text-xs text-slate-500 mt-1">橫排書適用。正面：[封底 | 封面]</span>
                                            </div>
                                        </label>

                                        <label className={`relative flex items-start p-4 border rounded-lg cursor-pointer transition-all ${binding === 'right' ? 'border-blue-500 bg-blue-50/50 ring-1 ring-blue-500' : 'border-slate-200 hover:border-slate-300'}`}>
                                            <input
                                                type="radio"
                                                name="binding"
                                                value="right"
                                                checked={binding === 'right'}
                                                onChange={() => handleBindingChange('right')}
                                                className="mt-1 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                                            />
                                            <div className="ml-3">
                                                <span className="block text-sm font-bold text-slate-800">右翻書 (Right Binding)</span>
                                                <span className="block text-xs text-slate-500 mt-1">直排書適用。正面：[封面 | 封底]</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                {/* Quality & Guides */}
                                <div className="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                                    <div className="flex items-center gap-2 mb-3">
                                        <IconImage className="w-5 h-5 text-slate-600" />
                                        <h3 className="font-bold text-slate-700">輸出設定 (Output)</h3>
                                    </div>

                                    {/* Quality Options */}
                                    <p className="text-sm text-slate-500 mb-2 ml-7">渲染品質 (Quality)</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 ml-7 mb-4">
                                        <label className={`relative flex items-center p-3 border rounded-lg cursor-pointer transition-all ${quality === 2.5 ? 'border-blue-500 bg-blue-50/50 ring-1 ring-blue-500' : 'border-slate-200 hover:border-slate-300'}`}>
                                            <input type="radio" name="quality" value="2.5" checked={quality === 2.5} onChange={() => handleQualityChange(2.5)} className="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" />
                                            <div className="ml-3">
                                                <span className="block text-sm font-bold text-slate-800">標準品質 (~180 DPI)</span>
                                                <span className="block text-xs text-slate-500">適合螢幕閱讀，速度快</span>
                                            </div>
                                        </label>

                                        <label className={`relative flex items-center p-3 border rounded-lg cursor-pointer transition-all ${quality === 4.17 ? 'border-blue-500 bg-blue-50/50 ring-1 ring-blue-500' : 'border-slate-200 hover:border-slate-300'}`}>
                                            <input type="radio" name="quality" value="4.17" checked={quality === 4.17} onChange={() => handleQualityChange(4.17)} className="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" />
                                            <div className="ml-3">
                                                <span className="block text-sm font-bold text-slate-800">印刷品質 (~300 DPI)</span>
                                                <span className="block text-xs text-slate-500">最高畫質，處理時間較長</span>
                                            </div>
                                        </label>
                                    </div>

                                    {/* Guides Option */}
                                    <div className="ml-7 border-t border-slate-100 pt-4">
                                        <label className="flex items-center gap-3 cursor-pointer">
                                            <div className="relative inline-flex items-center">
                                                <input
                                                    type="checkbox"
                                                    checked={drawGuides}
                                                    onChange={handleGuidesChange}
                                                    className="sr-only peer"
                                                />
                                                <div className="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <IconGrid className="w-4 h-4 text-slate-500" />
                                                <div>
                                                    <span className="text-sm font-bold text-slate-700">繪製裁切與對折參考線</span>
                                                    <span className="text-xs text-slate-500 ml-2">(水平裁切線 + 垂直對折線)</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Preview Section - Collapsible */}
                        {previewInfo && !isProcessing && (
                            <div className="mb-8 bg-slate-50 border border-slate-200 rounded-lg overflow-hidden animate-fade-in">
                                <div
                                    className="px-4 py-3 bg-slate-100 border-b border-slate-200 flex justify-between items-center cursor-pointer hover:bg-slate-200/80 transition-colors"
                                    onClick={() => setShowPreview(!showPreview)}
                                >
                                    <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                        <IconEye className="w-4 h-4" />
                                        拼版結構預覽
                                        {!showPreview && <span className="text-xs font-normal text-slate-500 ml-2">(點擊展開詳細資訊)</span>}
                                    </h3>
                                    <div className="flex items-center gap-3">
                                        <span className="text-xs text-slate-500">
                                            原稿 {previewInfo.originalPages} 頁 ➔ 產出 {previewInfo.finalPages} 頁 ({previewInfo.sheets} 張 A4)
                                        </span>
                                        {showPreview ? <IconChevronUp className="w-4 h-4 text-slate-500" /> : <IconChevronDown className="w-4 h-4 text-slate-500" />}
                                    </div>
                                </div>

                                {showPreview && (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left text-slate-600">
                                            <thead className="text-xs text-slate-700 uppercase bg-slate-100 border-b border-slate-200">
                                                <tr>
                                                    <th className="px-4 py-2 text-center w-16">Sheet</th>
                                                    <th className="px-4 py-2 text-center w-20">Side</th>
                                                    <th className="px-4 py-2 text-center">Left (左側)</th>
                                                    <th className="px-4 py-2 text-center">Right (右側)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {previewInfo.rows.map((row, idx) => (
                                                    <tr key={idx} className={`border-b border-slate-100 hover:bg-white ${idx % 2 === 0 ? 'bg-slate-50/50' : 'bg-white'}`}>
                                                        {idx % 2 === 0 && (
                                                            <td rowSpan={2} className="px-4 py-2 text-center font-bold border-r border-slate-200 bg-white">
                                                                {row.sheet}
                                                            </td>
                                                        )}
                                                        <td className={`px-4 py-2 text-center font-medium text-xs ${row.side === 'FRONT' ? 'text-blue-600' : 'text-orange-500'}`}>
                                                            {row.side}
                                                        </td>
                                                        <td className="px-4 py-2 text-center">
                                                            <div className="flex flex-col gap-1">
                                                                <span className="text-xs text-slate-400">上 <span className={`text-sm font-semibold ml-1 ${getPageLabel(row.left.top) === '-' ? 'text-slate-300' : 'text-slate-700'}`}>{getPageLabel(row.left.top)}</span></span>
                                                                <span className="text-xs text-slate-400">下 <span className={`text-sm font-semibold ml-1 ${getPageLabel(row.left.bottom) === '-' ? 'text-slate-300' : 'text-slate-700'}`}>{getPageLabel(row.left.bottom)}</span></span>
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-2 text-center">
                                                            <div className="flex flex-col gap-1">
                                                                <span className="text-xs text-slate-400">上 <span className={`text-sm font-semibold ml-1 ${getPageLabel(row.right.top) === '-' ? 'text-slate-300' : 'text-slate-700'}`}>{getPageLabel(row.right.top)}</span></span>
                                                                <span className="text-xs text-slate-400">下 <span className={`text-sm font-semibold ml-1 ${getPageLabel(row.right.bottom) === '-' ? 'text-slate-300' : 'text-slate-700'}`}>{getPageLabel(row.right.bottom)}</span></span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Controls */}
                        <div className="flex justify-center mb-8">
                            <button
                                onClick={processPDF}
                                disabled={!file || isProcessing}
                                className={`px-8 py-3 rounded-lg font-semibold text-white flex items-center gap-2 shadow-md transition-all ${!file || isProcessing ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 hover:scale-105'}`}
                            >
                                {isProcessing ? (
                                    <>
                                        <div className="loader"></div>
                                        <span>{progress}</span>
                                    </>
                                ) : (
                                    <>
                                        <IconLayers className="w-5 h-5" />
                                        <span>開始轉換</span>
                                    </>
                                )}
                            </button>
                        </div>

                        {/* Error Message */}
                        {error && (
                            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-3 text-red-700">
                                <IconAlertCircle className="w-5 h-5" />
                                <p>{error}</p>
                            </div>
                        )}

                        {/* Success / Download */}
                        {downloadUrl && stats && (
                            <div className="bg-green-50 border border-green-200 rounded-xl p-6 animate-fade-in">
                                <div className="flex items-start justify-between mb-4">
                                    <div className="flex items-center gap-3">
                                        <IconCheckCircle2 className="w-8 h-8 text-green-600" />
                                        <div>
                                            <h3 className="text-lg font-bold text-green-800">轉換成功！</h3>
                                            <p className="text-sm text-green-700">
                                                原檔 {stats.originalPages} 頁 ➔ 產出 {stats.sheets} 張 A4 ({stats.sheets * 2} 面)
                                            </p>
                                            {stats.blanks > 0 && (
                                                <p className="text-xs text-green-600 mt-1">
                                                    *書冊補齊 {stats.blanks} 頁 (不含裁切區空白)
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                    <a
                                        href={downloadUrl}
                                        download={`A6_Booklet_${file.name}`}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 flex items-center gap-2 shadow-sm"
                                    >
                                        <IconDownload className="w-4 h-4" />
                                        下載檔案
                                    </a>
                                </div>

                                {/* Instructions Diagram - Updated to 2x2 Grid with Updated Step 2 */}
                                <div className="border-t border-green-200 pt-4 mt-4">
                                    <h4 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <IconScissors className="w-4 h-4" />
                                        製作教學：切分堆疊法 (Cut & Stack)
                                    </h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                                        {/* Step 1 */}
                                        <div className="bg-white p-4 rounded border border-gray-200">
                                            <strong className="block text-gray-800 mb-2 text-sm">1. 雙面列印</strong>
                                            <div className="h-24 bg-gray-50 border border-gray-100 mb-2 flex items-center justify-center">
                                                <div className="w-12 h-16 bg-white border border-gray-300 flex items-center justify-center shadow-sm relative">
                                                    <div className="text-[8px] text-gray-300">A4</div>
                                                    <div className="absolute bottom-0 right-0 w-3 h-3 bg-gray-100 border-l border-t border-gray-200"></div>
                                                </div>
                                            </div>
                                            <p className="text-sm text-gray-500">使用 A4 紙進行雙面列印，並選擇長邊翻頁設定。</p>
                                        </div>

                                        {/* Step 2 - Updated Visual */}
                                        <div className="bg-white p-4 rounded border border-gray-200">
                                            <strong className="block text-gray-800 mb-2 text-sm">2. 水平裁切</strong>
                                            <div className="relative h-24 bg-gray-50 border border-gray-100 mb-2 flex items-center justify-center px-8 py-2">
                                                {/* Paper Sheet - Made taller and narrower to resemble A4 */}
                                                <div className="w-24 h-full bg-white border border-gray-300 flex flex-col relative shadow-sm">
                                                    <div className="flex-1 flex items-center justify-center text-[10px] text-gray-400">
                                                        上半部
                                                    </div>
                                                    {/* Cut Line */}
                                                    <div className="w-full border-b border-dashed border-red-400"></div>
                                                    <div className="flex-1 flex items-center justify-center text-[10px] text-gray-400">
                                                        下半部
                                                    </div>
                                                    {/* Scissors - Positioned outside */}
                                                    <div className="absolute -right-6 top-1/2 -translate-y-1/2 text-red-500">
                                                        <IconScissors className="w-4 h-4" />
                                                    </div>
                                                </div>
                                            </div>
                                            <p className="text-sm text-gray-500">將整疊紙從中間水平切開。</p>
                                        </div>

                                        {/* Step 3 */}
                                        <div className="bg-white p-4 rounded border border-gray-200">
                                            <strong className="block text-gray-800 mb-2 text-sm">3. 堆疊對折</strong>
                                            <div className="flex items-center justify-around h-24 bg-gray-50 mb-2 px-4">
                                                <div className="flex flex-col items-center">
                                                    <div className="w-8 h-6 bg-white border border-gray-400 shadow-sm text-[8px] flex items-center justify-center">上</div>
                                                    <IconArrowDown className="w-3 h-3 text-gray-400 my-1" />
                                                    <div className="w-8 h-6 bg-gray-200 border border-gray-400 text-[8px] flex items-center justify-center">下</div>
                                                </div>
                                                <div className="text-gray-300 text-lg">➔</div>
                                                <IconFoldAction className="w-10 h-10 text-blue-500" />
                                            </div>
                                            <p className="text-sm text-gray-500">
                                                將裁切好的「上半疊」（包含封面）直接疊放在「下半疊」的上方。<br />
                                                <span className="text-xs text-red-400">(若最下方有空白紙張請取出)</span><br />
                                                接著將整疊紙張先沿著左右兩半的中央虛線對折 (封面朝外)。
                                            </p>
                                        </div>

                                        {/* Step 4 */}
                                        <div className="bg-white p-4 rounded border border-gray-200">
                                            <strong className="block text-gray-800 mb-2 text-sm">4. 裝訂</strong>
                                            <div className="h-24 bg-gray-50 border border-gray-100 mb-2 flex items-center justify-center">
                                                <IconStaple className="w-12 h-12 text-gray-600" />
                                            </div>
                                            <p className="text-sm text-gray-500">使用釘書機或長尾夾，固定於中線處裝訂即完成。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <footer className="mt-8 text-gray-400 text-sm">
                        所有運算在本地完成，您的檔案不會上傳至網路。
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>